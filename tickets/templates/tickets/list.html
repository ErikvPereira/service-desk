{% extends "base.html" %}
{% block title %}Meus Chamados{% endblock %}
{% block content %}
<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-4">
    <label class="form-label">Buscar</label>
    <input
      type="text"
      name="q"
      value="{{ q|default:'' }}"
      class="form-control"
      placeholder="Título ou descrição..."
    />
  </div>

  <div class="col-md-2">
    <label class="form-label">Status</label>
    <select name="status" class="form-select">
      <option value="">Todos</option>
      <option value="OPEN" {% if status == "OPEN" %}selected{% endif %}>OPEN</option>
      <option value="CLOSED" {% if status == "CLOSED" %}selected{% endif %}>CLOSED</option>
    </select>
  </div>

  <div class="col-md-2">
  <label class="form-label">Prioridade</label>
  <select name="priority" class="form-select">
    <option value="">Todas</option>
    {% for value, label in priority_choices %}
      <option value="{{ value }}" {% if priority == value %}selected{% endif %}>
        {{ label }}
      </option>
    {% endfor %}
  </select>
  </div>


  <div class="col-md-2">
  <label class="form-label">Categoria</label>
  <select name="category" class="form-select">
    <option value="">Todas</option>
  {% for value, label in category_choices %}
    <option value="{{ value }}" {% if category == value %}selected{% endif %}>
      {{ label }}
    </option>
  {% endfor %}
  </select>
</div>

  <div class="col-md-2 d-flex gap-2">
    <button class="btn btn-dark w-100" type="submit">Filtrar</button>
    <a class="btn btn-outline-secondary w-100" href="{% url 'ticket_list' %}">Limpar</a>
  </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 m-0">Meus Chamados</h1>
  <a class="btn btn-primary btn-sm" href="/tickets/new/">Novo chamado</a>
</div>



<div class="card shadow-sm">
  <div class="card-body">
    {% if tickets %}
      <ul class="list-group">
        {% for t in tickets %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <a href="{% url 'ticket_detail' t.id %}">
                  <strong>#{{ t.id }}</strong> {{ t.title }}
                </a>
                <div class="small text-muted">{{ t.created_at|date:"d/m/Y H:i" }}</div>
              </div>

              <div class="d-flex align-items-center gap-2">
                {# STATUS #}
                {% if t.status == "OPEN" %}
                  <span class="badge text-bg-success">{{ t.get_status_display }}</span>
                {% elif t.status == "IN_PROGRESS" %}
                  <span class="badge text-bg-primary">{{ t.get_status_display }}</span>
                {% elif t.status == "RESOLVED" %}
                  <span class="badge text-bg-warning">{{ t.get_status_display }}</span>
                {% else %}
                  <span class="badge text-bg-secondary">{{ t.get_status_display }}</span>
                {% endif %}

                {# PRIORIDADE #}
                {% if t.priority == "URGENT" %}
                  <span class="badge text-bg-danger">{{ t.get_priority_display }}</span>
                {% elif t.priority == "HIGH" %}
                  <span class="badge text-bg-warning">{{ t.get_priority_display }}</span>
                {% elif t.priority == "MEDIUM" %}
                  <span class="badge text-bg-info">{{ t.get_priority_display }}</span>
                {% else %}
                  <span class="badge text-bg-light text-dark border">{{ t.get_priority_display }}</span>
                {% endif %}

                {# CATEGORIA #}
                <span class="badge text-bg-light text-dark border">{{ t.get_category_display }}</span>
              </div>
          </li>
        {% endfor %}
      </ul>
      {% if page_obj.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm mb-0">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}&category={{ category }}&priority={{ priority }}">Anterior</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}&category={{ category }}&priority={{ priority }}">Próxima</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Próxima</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

    {% else %}
      <p class="text-muted mb-0">Você ainda não tem chamados. Clique em “Novo chamado”.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
